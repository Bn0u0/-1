<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>PicPet — Co-Op PWA v0.5.3（GitHub Pages 共享版）</title>
  <meta name="theme-color" content="#10b981" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gradient-to-b from-sky-50 to-amber-50">
  <div id="root"></div>
  <script type="text/babel" data-presets="typescript,react">
    const { useState, useEffect, useRef } = React;

    const STORAGE_KEY_BASE = "picpet_v0_state";
    const FEED_XP_GAIN = 22;
    const FEED_HUNGER_GAIN = 35;
    const HUNGER_DECAY_PER_MIN = 2;

    const clamp = (n,a,b)=>Math.min(b,Math.max(a,n));
    const genRoomId = ()=>Math.random().toString(36).slice(2,8).toUpperCase();
    const ensureRoomInURL = ()=>{const u=new URL(location.href);let r=u.searchParams.get('room');if(!r){r=genRoomId();u.searchParams.set('room',r);history.replaceState(null,'',u.toString());}return r;};
    const storageKeyFor = (room)=>`${STORAGE_KEY_BASE}::${room}`;
    const loadState=(room)=>{try{return JSON.parse(localStorage.getItem(storageKeyFor(room)))}catch{return null}};
    const saveState=(room,data)=>{try{localStorage.setItem(storageKeyFor(room),JSON.stringify(data))}catch{}};

    async function fileToDataURL(file){
      return await new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(String(fr.result));fr.onerror=rej;fr.readAsDataURL(file);});
    }

    function simulateFeed(prev){
      let hunger=clamp(prev.hunger+FEED_HUNGER_GAIN,0,100);
      let xp=prev.xp+FEED_XP_GAIN;let level=prev.level;
      while(xp>=100){xp-=100;level+=1;}
      return {...prev,hunger,xp,level};
    }

    function App(){
      const fileRef=useRef(null);
      const [roomId,setRoomId]=useState(()=>ensureRoomInURL());
      const [pet,setPet]=useState(()=>loadState(roomId)?.pet ?? {name:'水水',level:1,xp:0,hunger:75,lastTick:Date.now()});
      const [gallery,setGallery]=useState(()=>loadState(roomId)?.gallery ?? []);
      const [toast,setToast]=useState(null);

      useEffect(()=>{saveState(roomId,{pet,gallery});},[pet,gallery,roomId]);

      // 同步機制：使用 localStorage 事件模擬多人共享
      useEffect(()=>{
        const onStorage=(e)=>{if(e.key===storageKeyFor(roomId)&&e.newValue){try{const v=JSON.parse(e.newValue);if(v.pet) setPet(v.pet);if(v.gallery) setGallery(v.gallery);}catch{}}};
        window.addEventListener('storage',onStorage);
        return ()=>window.removeEventListener('storage',onStorage);
      },[roomId]);

      useEffect(()=>{
        const t=setInterval(()=>{
          setPet(prev=>{const now=Date.now();const dt=(now-prev.lastTick)/60000;const hunger=clamp(prev.hunger-dt*HUNGER_DECAY_PER_MIN,0,100);const next={...prev,hunger,lastTick:now};saveState(roomId,{pet:next,gallery});return next;});
        },5000);
        return()=>clearInterval(t);
      },[roomId,gallery]);

      const handleFeed=async(file)=>{
        const data=await fileToDataURL(file);
        setGallery(prev=>{const next=[data,...prev].slice(0,24);saveState(roomId,{pet,gallery:next});return next;});
        setPet(prev=>{const next=simulateFeed(prev);saveState(roomId,{pet:next,gallery:[data,...gallery].slice(0,24)});return next;});
        setToast(`+${FEED_HUNGER_GAIN} 飢餓, +${FEED_XP_GAIN} XP`);
        setTimeout(()=>setToast(null),1500);
      };

      const invite=async()=>{
        const u=new URL(location.href);
        u.searchParams.set('room',roomId);
        try{await navigator.clipboard.writeText(u.toString());alert("已複製邀請連結，貼給朋友就能同步!")}catch{alert("複製失敗，請手動複製網址");}
      };

      return (
        <div className="max-w-md mx-auto py-6">
          <h1 className="text-xl font-bold mb-2">PicPet — Co-Op</h1>
          <p className="text-sm opacity-70 mb-4">房間：{roomId} ｜ 複製連結給朋友即可同步</p>

          <div className="p-4 rounded-2xl bg-white shadow mb-4">
            <p className="mb-2">名字：{pet.name} ｜ 等級：{pet.level}</p>
            <p className="mb-2">XP：{pet.xp}/100 ｜ 飢餓：{Math.round(pet.hunger)}/100</p>
            <button onClick={()=>fileRef.current.click()} className="px-3 py-2 bg-emerald-500 text-white rounded-xl">餵一張</button>
            <button onClick={invite} className="ml-2 px-3 py-2 bg-indigo-600 text-white rounded-xl">邀請</button>
          </div>

          <div className="p-4 rounded-2xl bg-white shadow">
            <h2 className="font-semibold mb-2">相片牆（{gallery.length}）</h2>
            {gallery.length===0? <p className="text-sm opacity-70">還沒有照片</p> : (
              <div className="grid grid-cols-3 gap-2">
                {gallery.map((src,i)=>(<img key={i} src={src} className="w-full h-full object-cover rounded-xl"/>))}
              </div>
            )}
          </div>

          <input ref={fileRef} type="file" accept="image/*" className="hidden" onChange={(e)=>{const f=e.target.files?.[0];if(f) handleFeed(f); e.target.value='';}} />

          {toast && (<div className="fixed top-4 right-4 bg-emerald-600 text-white px-3 py-2 rounded-xl shadow">{toast}</div>)}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
